name: Deploy

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    steps:
      - name: Deploy to Render (Deploy Hook)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          set -euo pipefail
          if [ -z "${RENDER_DEPLOY_HOOK:-}" ]; then
            echo "RENDER_DEPLOY_HOOK secret not set. Create a Deploy Hook in Render and add it as the secret 'RENDER_DEPLOY_HOOK' in GitHub." >&2
            exit 1
          fi
          echo "Triggering Render deploy via Deploy Hook"
          curl -sS -X POST "$RENDER_DEPLOY_HOOK" -o render-deploy-response.json -w "HTTP:%{http_code}\n"
          echo "Deploy hook called. Response body:" && cat render-deploy-response.json
          echo "Done"
